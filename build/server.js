!function(e){function t(n){if(s[n])return s[n].exports;var o=s[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var s={};return t.m=e,t.c=s,t.p="",t(0)}([function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var o=s(1),r=s(2),a=n(r),u=s(3),i=n(u),c=s(4),d=n(c),l=s(5),p=n(l),f=s(6),h=n(f),v=s(7),g=n(v),m=s(8),P=n(m),w=s(9),y=n(w),b=s(12);s(34);var E=s(10),_=n(E),I=s(37)(p.default),A=process.env.MAIN_SERVER_PORT;A||(A=3009);var M=(0,d.default)(),N=(0,o.Server)(M),T=new P.default(N),O=function(e){b.PostController.getPostsSinceDate(e).then(function(e){e&&T.emit("messages",e)})},R=function(e,t){T.emit("tick",e,t)};new y.default(5,O,R);M.use((0,a.default)("build/public/assets/favicon.ico")),M.use(function(e,t,s,n){s.headersSent&&n(e),s.status(e.status||x).render("500")}),M.use(d.default.static("build/public")),M.use(i.default.json()),M.use(i.default.urlencoded({extended:!0}));var j=(0,p.default)({name:"ccs",secret:"MmyWTLNNsTi15L8n3iUH8kls",resave:!0,saveUninitialized:!1,store:new I({client:_.default})});M.use(j),M.use(g.default.initialize()),M.use(g.default.session()),M.use((0,h.default)("combined")),T.use(function(e,t){j(e.request,{},t)}),M.use("/api/v1",[b.accountRoutes,b.authenticationRoutes,b.postRoutes]);var S=function(){var e=[],t=0,s=Object.keys(T.eio.clients);s.forEach(function(s){var n=T.eio.clients[s].request.session;n&&n.passport&&n.passport.user?e.push(n.passport.user.displayName):t+=1}),t>0&&e.push(t+" guests"),T.emit("listeners",e)};T.on("connection",function(e){console.log("CONNECTION"),S(),e.on("nick",function(t){e.nick=t,S()})}),M.get("/",function(e,t){t.send("Hello - this is the api server. You probably want a more interesting endpoint.")}),process.on("SIGTERM",function(){console.log("Closing server."),M.close()}),M.on("close",function(){console.log("Closing redis."),_.default.quit()});var x=process.env.PORT||A;N.listen(x,function(e){e?console.log("Server ERROR on startup: "+e):console.log("Server listening on http://localhost:"+x+".")})},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("serve-favicon")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("socket.io")},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}(),a=s(10),u=n(a),i=null,c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,s=arguments[1],n=arguments[2];return o(this,e),i?i:(this.ringCallback=s,this.tickTockCallback=n,this.timeSpreadMinutes=t,this.updateTick=5e3,this.lastTimestamp=u.default.get("lastTranche"),this.lastTime||this.setLastTimeToNow(),this.runner=setInterval(this.tickTock.bind(this),this.updateTick),void(i=this))}return r(e,[{key:"setLastTimeToNow",value:function(){this.lastTimestamp=Date.now(),u.default.set("lastTranche",this.lastTimestamp)}},{key:"tickTock",value:function(){var e=6e4*this.timeSpreadMinutes,t=this.lastTimestamp+e,s=Date.now();if(t<s){var n=this.lastTimestamp;this.setLastTimeToNow(),this.ringCallback(n)}this.tickTockCallback(s,t)}}]),e}();t.default=c},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=s(11),r=n(o),a=process.env.REDIS_URL,u=r.default.createClient(a);u.on("error",function(e){console.log("Redis connection error "+e)}),t.default=u},function(e,t){e.exports=require("redis")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(13);Object.keys(n).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}})});var o=s(26);Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}})});var r=s(31);Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}})})},function(e,t,s){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.AccountController=t.accountRoutes=void 0;var r=s(14),a=o(r),u=s(15),i=n(u);t.accountRoutes=a.default,t.AccountController=i},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(4),o=s(15),r=s(26),a=new n.Router;a.route("/accounts").post(o.addAccountEndpoint),a.get("/accounts",(0,r.ensureLoggedIn)(),o.getAccountInfoEndpoint),t.default=a},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(16),o=n.Account,r=function(e){var t=e.user,s=e.body.onBehalfOfId;return s&&s.length>0&&t&&t.canActOnBehalfOf(s)?s:e.user&&e.user.id?e.user.id:null},a=function(e,t){var s=e.body,n=s.email,r=s.password,a=s.displayName,u=o.build({email:n,displayName:a});u.setPassword(r).then(function(){return u.save()}).then(function(s){e.login(s,function(e){console.log("Failed login after creation: "+e)});var n=s.toJSON();t.status(201).json({success:!0,message:"Successfully Registered",account:n})}).catch(function(e){if(11e3===e.code)return t.statusMessage="Account with that email already exists",void t.status(409).end();var s="Account could not be created.";e.message&&(s=e.message.replace(/(\r\n|\n|\r)/gm," ")),t.statusMessage=s,t.status(422).send(JSON.stringify({errors:e.message}))})},u=function(e,t){var s=r(e);return s?void o.findById(s).then(function(e){var s=e.toJSON();t.status(201).json({success:!0,account:s})}).catch(function(e){t.statusMessage=e.message,t.status(422).end()}):t.status(422).json({success:!1,message:"No accountId provided"})},i=function(e,t){t.status(418).json({message:"Brewing"})};t.addAccountEndpoint=a,t.updateAccountEndpoint=i,t.getAccountInfoEndpoint=u},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var o=s(17),r=n(o),a=s(18),u=n(a),i=s(25),c=n(i),d={development:{username:"mdw",password:null,database:"calmcomment",host:"127.0.0.1",dialect:"postgres"},test:{username:"root",password:null,database:"database_test",host:"127.0.0.1",dialect:"postgres"},production:{username:"root",password:null,database:"database_production",host:"127.0.0.1",dialect:"postgres"}},l="production",p=d[l],f=null;f=process.env.DATABASE_URL?new r.default(process.env.DATABASE_URL):new r.default(p.database,p.username,p.password,p);var h={};f.authenticate().then(function(){console.log("Success: Connection to Postgres established .")},function(e){console.log("FAILURE: Unable to connect to the Postgres database:",e)});var v=(0,u.default)(f,r.default);h[v.name]=v;var g=(0,c.default)(f,r.default);h[g.name]=g,Object.keys(h).forEach(function(e){"associate"in h[e]&&h[e].associate(h)}),f.sync().then(function(){console.log("Success: Synced models to database.")},function(e){console.log("FAILURE: An error occurred while creating the table:",e)}),h.sequelize=f,h.Sequelize=r.default,e.exports=h},function(e,t){e.exports=require("sequelize")},function(e,t,s){"use strict";var n=s(19),o=s(22);e.exports=function(e,t){var s=e.define("Account",{displayName:{type:t.STRING,allowNull:!1,validate:{isValidDisplayName:function(e){var t=(0,o.appraiseDisplayName)(e);if(t.length>0)throw new Error(t.join(" "))}}},email:{type:t.STRING,allowNull:!1,validate:{isValidEmail:function(e){var t=(0,o.appraiseEmail)(e);if(t.length>0)throw new Error(t.join(" "))}},unique:!0},encryptedPasswordHash:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},encryptedPasswordPepperId:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0}}},{instanceMethods:{setPassword:function(e){var t=this;return Promise.resolve((0,o.appraisePassword)(e)).then(function(t){if(t.length>0)throw new Error(t.join(", "));return e}).then(function(e){return(0,n.encryptPassword)(e)}).then(function(e){t.encryptedPasswordHash=e.encrypted,t.encryptedPasswordPepperId=e.pepperId}).catch(function(e){throw e})},toJSON:function(){var e=Object.assign({},this.get());return delete e.encryptedPasswordHash,delete e.encryptedPasswordPepperId,delete e.deletedAt,e},toProfile:function(){var e=Object.assign({},this.get());return delete e.encryptedPasswordHash,delete e.encryptedPasswordPepperId,delete e.email,delete e.deletedAt,e},comparePassword:function(e){return(0,n.passwordsMatch)(e,this.encryptedPasswordHash,this.encryptedPasswordPepperId)}},classMethods:{associate:function(e){s.hasMany(e.Post)}}});return s}},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.passwordsMatch=t.aesHash=t.bcryptHash=t.hashPassword=t.deAesHash=t.encryptPassword=void 0;var o=s(20),r=s(21),a=n(r),u=function(e){var t=a.default.createHash("sha512");t.update(e);var s=t.digest("hex");return s},i=function(e){var t=10;return(0,o.hash)(e,t)},c=function(e){var t=process.env.ACCOUNT_ENCRYPT_CURRENT_PEPPER,s=process.env[t],n="aes-256-ctr",o=a.default.createCipher(n,s),r=o.update(e,"utf8","hex");return r+=o.final("hex"),{encrypted:r,pepperId:t}},d=function(e){return Promise.resolve(e).then(u).then(i).then(c)},l=function(e,t){var s=process.env[t];if(!s)return new Error("Pepper not found.");var n="aes-256-ctr",o=a.default.createDecipher(n,s),r=o.update(e,"hex","utf8");return r+=o.final("utf8")},p=function(e,t,s){var n=u(e),r=l(t,s);return(0,o.compare)(n,r)};t.encryptPassword=d,t.deAesHash=l,t.hashPassword=u,t.bcryptHash=i,t.aesHash=c,t.passwordsMatch=p},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("crypto")},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.appraisePostMessage=t.appraisePostSubject=t.appraiseAccountId=t.appraisePasswordErrors=t.appraisePasswordExtra=t.appraisePassword=t.appraiseDisplayName=t.appraiseEmail=t.appraiseThese=void 0;var o=s(23),r=s(24),a=n(r),u=function(e){var t=[];return(0,o.isEmpty)(e)&&t.push("Email address is required."),(0,o.isEmpty)(e)||(0,o.isEmail)(e)||t.push("Email address does not appear to be valid."),t},i=function(e){var t=[];return(0,o.isEmpty)(e)&&t.push("Display name is required."),t},c=function(e){var t=[];if((0,o.isEmpty)(e))t.push("Password is required.");else{var s=a.default.test(e);s.strong||(t=t.concat(s.errors))}return t},d={minLength:0,maxLength:1,repeating:2,needLowercase:3,needUppercase:4,needNumber:5,needCharacter:6},l=function(e){return a.default.test(e)},p=function(e){var t=[];return(0,o.isEmpty)(e)&&t.push("AccountId is required."),t},f=function(e){var t={success:!0,tested:[],errors:{}};if("email"in e){t.tested.push("email");var s=u(e.email);s&&s.length>0&&(t.success=!1,t.errors.email=s)}if("password"in e){t.tested.push("password");var n=c(e.password);n&&n.length>0&&(t.success=!1,t.errors.password=n)}if("displayName"in e){t.tested.push("displayName");var o=i(e.displayName);o&&o.length>0&&(t.success=!1,t.errors.displayName=o)}if("accountId"in e){t.tested.push("accountId");var r=p(e.accountId);r&&r.length>0&&(t.success=!1,t.errors.accountId=r)}return t},h=function(e){var t=[];return e&&!(0,o.isEmpty)(e)||t.push("A message is required."),t},v=function(e){return[]};t.appraiseThese=f,t.appraiseEmail=u,t.appraiseDisplayName=i,t.appraisePassword=c,t.appraisePasswordExtra=l,t.appraisePasswordErrors=d,t.appraiseAccountId=p,t.appraisePostSubject=v,t.appraisePostMessage=h},function(e,t){e.exports=require("validator")},function(e,t){e.exports=require("owasp-password-strength-test")},function(e,t){"use strict";e.exports=function(e,t){var s=e.define("Post",{message:{type:t.STRING,allowNull:!1},edited:{type:t.BOOLEAN}},{timestamps:!0,paranoid:!0,classMethods:{associate:function(e){s.belongsTo(e.Account)}}});return s}},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.authenticationRoutes=t.ensureLoggedIn=void 0,s(27);var o=s(29),r=n(o),a=s(30),u=n(a);t.ensureLoggedIn=r.default,t.authenticationRoutes=u.default},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var o=s(28),r=s(7),a=n(r),u=s(16),i=n(u),c=i.default.Account;a.default.use(new o.Strategy({usernameField:"email",passwordField:"password"},function(e,t,s){var n=null;c.find({where:{email:e}}).then(function(e){return n=e,e.comparePassword(t)}).then(function(e){if(!e)throw new Error("Could not verify account");return n}).then(function(e){s(null,e)}).catch(function(e){return console.log("Passport authentication failed: Unknown error: "+e),s(null,!1,{message:"Could not authenticate account"})})})),a.default.serializeUser(function(e,t){t(null,e.id)}),a.default.deserializeUser(function(e,t){c.findById(e).then(function(e){return t(null,e)}).catch(function(e){return t(e)})})},function(e,t){e.exports=require("passport-local")},function(e,t){"use strict";function s(e){var t="/login";"string"==typeof e?t=e:e&&e.redirectTo&&e.redirectTo.length>0&&(t=e.redirectTo);var s=e||{},n=void 0===s.setReturnTo||e.setReturnTo;return function(e,s,o){return e.isAuthenticated&&e.isAuthenticated()?void o():(n&&e.session&&(e.session.returnTo=e.originalUrl||e.url),s.redirect(t))}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=s},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function o(e,t,s){u.default.authenticate("local",function(n,o){return n||!o?(t.statusMessage="Could not log in with that email and password combination.",void t.status(422).end()):void e.logIn(o,function(e){return e?s(e):(t.cookie("ccsl","y",{httpOnly:!1}),void t.status(201).json({success:!0,message:"Logged in",account:o}))})})(e,t,s)}Object.defineProperty(t,"__esModule",{value:!0});var r=s(4),a=s(7),u=n(a),i=new r.Router;i.route("/sessions").post(o),i.route("/sessions").delete(function(e,t){e.session.destroy(),e.logout(),t.clearCookie("ccsl"),t.status(204).end()}),i.route("/sessions").get(function(e,t){e.isAuthenticated&&e.isAuthenticated()||t.status(204).end(),t.status(403).end()}),t.default=i},function(e,t,s){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.PostController=t.postRoutes=void 0;var r=s(32),a=o(r),u=s(33),i=n(u);t.postRoutes=a.default,t.PostController=i},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(4),o=s(33),r=s(26),a=new n.Router;a.get("/posts/:postId",o.getSinglePostEndpoint),a.get("/posts",o.getPostsEndpoint),a.post("/posts",(0,r.ensureLoggedIn)(),o.addPostEndpoint),a.put("/posts/:postId",(0,r.ensureLoggedIn)(),o.updatePostEndpoint),a.put("/posts/",(0,r.ensureLoggedIn)(),o.updatePostEndpoint),a.delete("/posts/:postId",(0,r.ensureLoggedIn)(),o.removePostEndpoint),t.default=a},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.removePostEndpoint=t.updatePostEndpoint=t.addPostEndpoint=t.getPostsSinceDate=t.getSinglePostEndpoint=t.getPostsEndpoint=void 0;var o=s(9),r=n(o),a=s(16),u=a.Post,i=a.Account,c=function(e){var t=new r.default,s=t.lastTimestamp;return e?{$or:[{AccountId:e},{createdAt:{$lt:new Date(s)}}]}:{createdAt:{$lt:new Date(s)}}},d=function(e,t){var s=null;e.user&&(s=e.user.id);var n=c(s);console.log("Where clause"),console.dir(n),u.findAll({where:n,include:[{model:i,attributes:["displayName"]}],attributes:["id","message","edited","createdAt","updatedAt","AccountId"],limit:30,order:[["createdAt","DESC"]]}).then(function(e){if(!e)throw new Error("Post not found");t.status(200).json({success:!0,posts:e})}).catch(function(e){t.statusMessage=e.message,t.status(404).end()})},l=function(e,t){var s=e.params.postId;s||t.status(422).json({success:!1,messages:"No PostId provided."}),u.find({where:{id:s},include:[{model:i,attributes:["displayName"]}],attributes:["id","message","edited","createdAt","updatedAt","AccountId"]}).then(function(e){if(!e)throw new Error("Post not found");t.status(200).json({success:!0,posts:e.toJSON()})}).catch(function(e){t.statusMessage=e.message,t.status(404).end()})},p=function(e){var t=new r.default,s=t.lastTimestamp;return u.findAll({where:{createdAt:{$lt:new Date(s),$gt:new Date(e)},updatedAt:{$lt:new Date(s),$gt:new Date(e)}},include:[{model:i,attributes:["displayName"]}],attributes:["id","message","edited","createdAt","updatedAt","AccountId"],limit:30,order:[["createdAt","DESC"]]}).then(function(e){if(!e)throw new Error("Post not found");return e}).catch(function(e){return e})},f=function(e,t){var s=e.user.id;s||(t.statusMessage="No accountId provided",t.status(422).end());var n=u.build({message:e.body.message,AccountId:s});n.save().then(function(e){if(!e)throw new Error("Post could not be created");var s=e.toJSON();t.status(201).json({success:!0,message:"Successfully created post",post:s})}).catch(function(e){var s="Post could not be created.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})},h=function(e,t){var s=e.user.id;s||(t.statusMessage="No accountId provided",t.status(422).end());var n=e.params.postId;e.body.postId&&(n=e.body.postId),n||t.status(422).json({success:!1,messages:"No PostId provided."}),0===e.body.message.length&&t.status(422).json({success:!1,messages:"Nothing to update."}),u.findOne({where:{id:n,AccountId:s}}).then(function(t){if(!t)throw new Error("Post could not be found to update");var s=t;return s.message=e.body.message,s.edited=!0,s.save()}).then(function(){t.status(205).json({success:!0,message:"Successfully updated post"})}).catch(function(e){var s="Post could not be updated.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})},v=function(e,t){var s=e.user.id;s||(t.statusMessage="No accountId provided",t.status(422).end());var n=e.params.postId;e.body.postId&&(n=e.body.postId),n||(t.statusMessage="No postId provided.",t.status(422).end()),u.findOne({where:{id:n,AccountId:s}}).then(function(e){return e.destroy()}).then(function(){t.status(204).end()}).catch(function(e){var s="Post could not be removed.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})};t.getPostsEndpoint=d,t.getSinglePostEndpoint=l,t.getPostsSinceDate=p,t.addPostEndpoint=f,t.updatePostEndpoint=h,t.removePostEndpoint=v},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var o=s(35),r=n(o),a=s(36),u=n(a);r.default.load(),(0,u.default)(["REDIS_URL","DATABASE_URL","MAIN_SERVER_PORT","ACCOUNT_PEPPER_1","ACCOUNT_ENCRYPT_CURRENT_PEPPER","IDIER_WORKER_ID"])},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("require-environment-variables")},function(e,t){e.exports=require("connect-redis")}]);
//# sourceMappingURL=server.js.map